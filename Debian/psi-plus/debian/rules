#!/usr/bin/make -f
# Uncomment this to turn on verbose mode.
#DH_VERBOSE=1

QMAKE=qmake-qt4
QCONF=qt-qconf
CONF=--enable-plugins --disable-bundled-qca --debug --no-separate-debug-info
#MAKEOPT=-j4

# This has to be exported to make some magic below work.
#export DH_OPTIONS

#select all plugins
plugs = $(notdir $(wildcard $(CURDIR)/src/plugins/generic/*plugin ) )

%:
	dh $@

override_dh_auto_configure:
	- QUILT_PC=.pc_psi quilt push -a --quiltrc /dev/null
	$(QCONF)
	./configure --prefix=/usr $(CONF)

override_dh_auto_build:
	$(MAKE) $(MAKEOPT)
	$(foreach plug,$(plugs), cd $(CURDIR)/src/plugins/generic/$(plug) && $(QMAKE) && $(MAKE); )

override_dh_auto_install:
	$(MAKE) INSTALL_ROOT=$(CURDIR)/debian/psi-plus install
	rm -f $(CURDIR)/debian/psi-plus/usr/bin/psi.debug #remove static debug file
	#Making the same, but using webkit
	$(MAKE) clean
	./configure --prefix=/usr $(CONF) --enable-webkit
	$(MAKE) $(MAKEOPT)
	$(MAKE) INSTALL_ROOT=$(CURDIR)/debian/psi-plus-webkit install
	rm $(CURDIR)/debian/psi-plus-webkit/usr/bin/psi
	rm $(CURDIR)/debian/psi-plus-webkit/usr/share/applications/psi.desktop
	cp $(CURDIR)/src/psi $(CURDIR)/debian/psi-plus-webkit/usr/bin/psi-webkit
	cp $(CURDIR)/debian/psi-webkit.desktop $(CURDIR)/debian/psi-plus-webkit/usr/share/applications/
	rm -f $(CURDIR)/debian/psi-plus-webkit/usr/bin/psi.debug #remove static debug file
	#Deleting temporary files
	rm -f $(CURDIR)/debian/psi-plus/usr/share/psi/COPYING
	rm -f $(CURDIR)/debian/psi-plus/usr/share/psi/README
	rm -f $(CURDIR)/debian/psi-plus-webkit/usr/share/psi/COPYING
	rm -f $(CURDIR)/debian/psi-plus-webkit/usr/share/psi/README

override_dh_install:
	dh_install
	#Deleting exported plugins
	rm -f $(CURDIR)/debian/psi-plus-plugins/usr/lib/psi/plugins/libcontentdownloaderplugin.so
	rm -f $(CURDIR)/debian/psi-plus-plugins/usr/lib/psi/plugins/libskinsplugin.so
	#Deleting exported icons
	rm -rf $(CURDIR)/debian/psi-plus-icons/usr/share/psi/iconsets/roster
	rm -rf $(CURDIR)/debian/psi-plus-icons/usr/share/psi/iconsets/clients
	rm -rf $(CURDIR)/debian/psi-plus-icons/usr/share/psi/iconsets/emoticons
	#Exporting all from psi-plus-common
	./debian/mergedups.sh

override_dh_auto_clean:
	dh_clean
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -f config.sub config.guess configure

	rm -f psi src/psi src/config.h
	rm -f Makefile src/Makefile libpsi/psiwidgets/Makefile
	rm -f conf.pri extra.pri conf.log
	rm -f src/.qmake.internal.cache

	rm -rf iris/lib iris/conf.pri
	rm -rf .qconftemp

	$(foreach plug,$(plugs), cd $(CURDIR)/src/plugins/generic/$(plug) && [ ! -f Makefile ] || $(MAKE) distclean; )

	- QUILT_PC=.pc_psi quilt pop -af --quiltrc /dev/null
	rm -rf .pc_psi

override_dh_strip:
	dh_strip -ppsi-plus --dbg-package=psi-plus-dbg
	dh_strip -ppsi-plus-webkit --dbg-package=psi-plus-webkit-dbg
	dh_strip -ppsi-plus-plugins --dbg-package=psi-plus-plugins-dbg
	dh_strip --remaining-packages

